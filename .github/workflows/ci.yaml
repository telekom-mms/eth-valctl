---
name: "CI Validation"

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - "develop"
      - "feature/*"
      - "hotfix/*"
  pull_request:
    branches:
      - "main"

jobs:
  validate:
    name: "Validate Code Quality"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v6"

      - name: "Setup Bun"
        uses: "oven-sh/setup-bun@v2"
        with:
          bun-version: "latest"

      - name: "Cache Bun dependencies"
        uses: "actions/cache@v5"
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: "${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}"
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: "Install dependencies"
        run: "bun install --frozen-lockfile"

      - name: "Type check"
        run: "bun run typecheck"

      - name: "Lint"
        run: "bun run lint"

  # yamllint disable-line rule:comments-indentation
      # Uncomment when tests are implemented
      # - name: "Run tests"
      #   run: "bun test"

  build-test:
    name: "Test Binary Build"
    runs-on: "ubuntu-latest"
    needs: "validate"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v6"

      - name: "Setup Bun"
        uses: "oven-sh/setup-bun@v2"
        with:
          bun-version: "latest"

      - name: "Cache Bun dependencies"
        uses: "actions/cache@v5"
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: "${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}"
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: "Install dependencies"
        run: "bun install --frozen-lockfile"

      - name: "Build linux-x64 binary"
        run: "bun run package linux-x64"

      - name: "Verify binary exists"
        run: |
          ls -la bin/
          test -f bin/eth-valctl-linux-x64

      - name: "Test binary execution"
        run: |
          chmod +x bin/eth-valctl-linux-x64
          ./bin/eth-valctl-linux-x64 --version
          ./bin/eth-valctl-linux-x64 --help
...
