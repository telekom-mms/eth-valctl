---
name: "Build Cross-Platform Binaries"

# yamllint disable-line rule:truthy
on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    name: "Build ${{ matrix.target }}"
    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        include:
          - target: "linux-x64"
            binary: "eth-valctl-linux-x64"
          - target: "linux-arm64"
            binary: "eth-valctl-linux-arm64"
          - target: "win-x64"
            binary: "eth-valctl-win-x64.exe"
          # yamllint disable rule:comments-indentation
          # TODO: macOS builds require code signing with Apple Developer cert
          # See scripts/package/entitlements.plist for required JIT entitlements
          # Required secrets for signing:
          #   APPLE_CERT_IDENTITY - Certificate identity
          #   APPLE_CERT_P12 - Base64 encoded .p12 certificate
          #   APPLE_CERT_PASSWORD - Certificate password
          # Signing command:
          #   codesign --deep --force -vvvv \
          #     --sign "$APPLE_CERT_IDENTITY" \
          #     --entitlements scripts/package/entitlements.plist \
          #     ./bin/eth-valctl-macos-*
          # Verification:
          #   codesign -vvv --verify ./bin/eth-valctl-macos-*
          # - target: "macos-x64"
          #   binary: "eth-valctl-macos-x64"
          # - target: "macos-arm64"
          #   binary: "eth-valctl-macos-arm64"
          # yamllint enable rule:comments-indentation

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v6"

      - name: "Setup Bun"
        uses: "oven-sh/setup-bun@v2"
        with:
          bun-version: "latest"

      - name: "Install dependencies"
        run: "bun install"

      - name: "Build binary"
        run: "bun run package ${{ matrix.target }}"

      - name: "Create compressed archive"
        shell: "bash"
        env:
          TARGET: "${{ matrix.target }}"
          TAG: "${{ github.ref_name }}"
          BINARY: "${{ matrix.binary }}"
        run: |
          cd bin
          tar -czvf "eth-valctl-${TARGET}-${TAG}.tar.gz" "$BINARY"

      - name: "Upload artifact"
        uses: "actions/upload-artifact@v6"
        env:
          TARGET: "${{ matrix.target }}"
          TAG: "${{ github.ref_name }}"
        with:
          name: "eth-valctl-${{ env.TARGET }}-${{ env.TAG }}"
          path: "bin/eth-valctl-${{ env.TARGET }}-${{ env.TAG }}.tar.gz"
          retention-days: 5

  verify:
    name: "Verify ${{ matrix.target }}"
    needs: "build"
    runs-on: "${{ matrix.os }}"
    strategy:
      matrix:
        include:
          - target: "linux-x64"
            os: "ubuntu-latest"
            binary: "eth-valctl-linux-x64"
          - target: "win-x64"
            os: "windows-latest"
            binary: "eth-valctl-win-x64.exe"

    steps:
      - name: "Download artifact"
        uses: "actions/download-artifact@v7"
        with:
          name: "eth-valctl-${{ matrix.target }}-${{ github.ref_name }}"
          path: "artifacts"

      - name: "Extract binary"
        shell: "bash"
        run: |
          cd artifacts
          tar -xzf eth-valctl-*.tar.gz
          ls -la

      - name: "Test binary execution (Unix)"
        if: "runner.os != 'Windows'"
        run: |
          chmod +x artifacts/${{ matrix.binary }}
          ./artifacts/${{ matrix.binary }} --version
          ./artifacts/${{ matrix.binary }} --help

      - name: "Test binary execution (Windows)"
        if: "runner.os == 'Windows'"
        shell: "cmd"
        run: |
          artifacts\${{ matrix.binary }} --version
          artifacts\${{ matrix.binary }} --help

  release:
    name: "Release new version"
    needs: "verify"
    runs-on: "ubuntu-latest"

    steps:
      - name: "Download all artifacts"
        uses: "actions/download-artifact@v7"
        with:
          path: "release-assets"

      - name: "List downloaded artifact directories"
        run: "ls -R release-assets"

      - name: "Flatten artifacts"
        run: |
          find release-assets -type f -name "*.tar.gz" -exec mv {} . \;
          echo "Files in workspace root after flattening:"
          ls -la

      - name: "Upload release assets"
        uses: "softprops/action-gh-release@v2"
        with:
          token: "${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          tag_name: "${{ github.ref_name }}"
          generate_release_notes: true
          files: |
            eth-valctl-linux-x64-${{ github.ref_name }}.tar.gz
            eth-valctl-linux-arm64-${{ github.ref_name }}.tar.gz
            eth-valctl-win-x64-${{ github.ref_name }}.tar.gz
...
